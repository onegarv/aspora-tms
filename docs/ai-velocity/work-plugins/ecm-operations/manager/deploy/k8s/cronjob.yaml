---
# ECM Manager Agent - Kubernetes CronJobs
# Daily flow at 7:00 AM IST (1:30 AM UTC)
# Pattern intelligence at 7:30 AM IST (2:00 AM UTC) — standalone fallback

# === Full morning flow (triage + patterns + Slack) ===
apiVersion: batch/v1
kind: CronJob
metadata:
  name: ecm-daily
  namespace: ecm-operations
  labels:
    app: ecm-manager
    component: daily-flow
spec:
  schedule: "30 1 * * *"
  timeZone: "Asia/Kolkata"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 5
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 1
      activeDeadlineSeconds: 900
      template:
        metadata:
          labels:
            app: ecm-manager
            flow: daily
        spec:
          restartPolicy: Never
          serviceAccountName: ecm-manager-sa
          containers:
            - name: manager
              image: ghcr.io/vance-club/ecm-manager:latest
              command: ["./entrypoint.sh", "daily"]
              envFrom:
                - secretRef:
                    name: ecm-manager-secrets
              env:
                - name: SPREADSHEET_ID
                  value: "1r50OEZlFVSUmU1tkLBqx2_BzlilZ3s0pArNHV83tRks"
                - name: SLACK_CHANNEL_ID
                  value: "C0AD6C36LVC"
              resources:
                requests:
                  memory: "512Mi"
                  cpu: "250m"
                limits:
                  memory: "1Gi"
                  cpu: "500m"

---
# === Triage only (ad-hoc schedule — 2PM, 8PM UAE) ===
apiVersion: batch/v1
kind: CronJob
metadata:
  name: ecm-triage
  namespace: ecm-operations
  labels:
    app: ecm-manager
    component: triage
spec:
  schedule: "0 10,16 * * *"
  timeZone: "Asia/Dubai"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 5
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 600
      template:
        metadata:
          labels:
            app: ecm-manager
            flow: triage
        spec:
          restartPolicy: Never
          serviceAccountName: ecm-manager-sa
          containers:
            - name: manager
              image: ghcr.io/vance-club/ecm-manager:latest
              command: ["./entrypoint.sh", "triage"]
              envFrom:
                - secretRef:
                    name: ecm-manager-secrets
              env:
                - name: SPREADSHEET_ID
                  value: "1r50OEZlFVSUmU1tkLBqx2_BzlilZ3s0pArNHV83tRks"
                - name: SLACK_CHANNEL_ID
                  value: "C0AD6C36LVC"
              resources:
                requests:
                  memory: "512Mi"
                  cpu: "250m"
                limits:
                  memory: "1Gi"
                  cpu: "500m"

---
# === Pattern intelligence only (standalone fallback) ===
apiVersion: batch/v1
kind: CronJob
metadata:
  name: ecm-patterns
  namespace: ecm-operations
  labels:
    app: ecm-manager
    component: patterns
spec:
  schedule: "0 2 * * *"
  timeZone: "Asia/Kolkata"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 5
  failedJobsHistoryLimit: 3
  suspend: true
  jobTemplate:
    spec:
      backoffLimit: 1
      activeDeadlineSeconds: 600
      template:
        metadata:
          labels:
            app: ecm-manager
            flow: patterns
        spec:
          restartPolicy: Never
          serviceAccountName: ecm-manager-sa
          containers:
            - name: manager
              image: ghcr.io/vance-club/ecm-manager:latest
              command: ["./entrypoint.sh", "patterns"]
              envFrom:
                - secretRef:
                    name: ecm-manager-secrets
              env:
                - name: SPREADSHEET_ID
                  value: "1r50OEZlFVSUmU1tkLBqx2_BzlilZ3s0pArNHV83tRks"
                - name: SLACK_CHANNEL_ID
                  value: "C0AD6C36LVC"
              resources:
                requests:
                  memory: "512Mi"
                  cpu: "250m"
                limits:
                  memory: "1Gi"
                  cpu: "500m"

---
# Secrets — apply separately with real values
apiVersion: v1
kind: Secret
metadata:
  name: ecm-manager-secrets
  namespace: ecm-operations
type: Opaque
stringData:
  ANTHROPIC_BASE_URL: "https://openrouter.ai/api"
  ANTHROPIC_AUTH_TOKEN: "sk-or-v1-xxx"
  ANTHROPIC_API_KEY: ""
  SLACK_BOT_TOKEN: "xoxb-xxx"

---
# ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ecm-manager-sa
  namespace: ecm-operations

---
# Namespace (if not exists)
apiVersion: v1
kind: Namespace
metadata:
  name: ecm-operations
